<div style="max-width:600px;margin:0 auto;">
    <!-- === FORM === -->
    <form id="wineForm" style="border:2px solid #000;padding:30px 25px;border-radius:8px;box-sizing:border-box;" onsubmit="return false;">
      <div style="display:flex;gap:10px;">
        <label style="flex:1;">First Name*<br><input type="text" id="firstName" name="first_name" required></label>
        <label style="flex:1;">Last Name*<br><input type="text" id="lastName" name="last_name" required></label>
      </div>
  
      <label>Email*<br><input type="email" id="email" name="email" required></label>
      <label>Phone*<br><input type="tel" id="phone" name="phone" required></label>
  
      <label>How many cases will you be storing with us?*</label>
      <div id="casesContainer" style="display:flex;flex-wrap:wrap;gap:10px;">
        <label style="width:45%"><input type="radio" name="cases" value="1-10" required> 1‚Äì10</label>
        <label style="width:45%"><input type="radio" name="cases" value="10-20"> 10‚Äì20</label>
        <label style="width:45%"><input type="radio" name="cases" value="20-40"> 20‚Äì40</label>
        <label style="width:45%"><input type="radio" name="cases" value="40-60"> 40‚Äì60</label>
        <label style="width:45%"><input type="radio" name="cases" value="60-100"> 60‚Äì100</label>
        <label style="width:45%"><input type="radio" name="cases" value="100-125"> 100‚Äì125</label>
        <label style="width:45%"><input type="radio" name="cases" value="125-140"> 125‚Äì140</label>
        <label style="width:45%"><input type="radio" name="cases" value="140-170"> 140‚Äì170</label>
        <label style="width:45%"><input type="radio" name="cases" value="170-225"> 170‚Äì225</label>
        <label style="width:45%"><input type="radio" name="cases" value="225-420"> 225‚Äì420</label>
        <label style="width:45%"><input type="radio" name="cases" value="420-690"> 420‚Äì690</label>
        <label style="width:45%"><input type="radio" name="cases" value="690-1000"> 690‚Äì1000</label>
        <label style="width:45%"><input type="radio" name="cases" value="1000+"> 1000+</label>
      </div>
  
      <label><input type="checkbox" id="robotCheck" name="not_a_robot" required> I am not a robot*</label>
      <input type="hidden" name="price_estimate" id="priceEstimateInput">
      <button type="button" id="submitBtn">Submit</button>
    </form>
  
    <!-- thank-you -->
    <div id="result" style="display:none;margin-top:20px;padding:15px;border:1px solid #ccc;border-radius:6px;">
      <p>‚úÖ Thank you! Your request has been submitted.</p>
      <p id="thankYouPrice" style="font-weight:500;"></p>
      <p>If you have any questions, please reach out to <a href="mailto:info@intlwinevault.com">info@intlwinevault.com</a>.</p>
      <small>
        <ol style="padding-left:20px;">
          <li>Unit sizes are based on a standard Bordeaux case.</li>
          <li>Prices are quoted in six-month intervals.</li>
          <li>Amounts shown are conservative estimates and are subject to change.</li>
        </ol>
      </small>
    </div>
  </div>
  
  <style>
    form input, form select {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
  
    form label {
      font-weight: 500;
      display: block;
      margin-bottom: 10px;
    }
  
    form > * {
      margin-bottom: 15px;
    }
  
    button {
      background-color: #333;
      color: white;
      padding: 12px 20px;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
    }
  
    button:hover:not(:disabled) {
      background-color: #555;
    }
  
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
  
    .required {
      color: red;
      margin-left: 3px;
    }
    
    .wine-form-hidden {
      display: none !important;
    }
    
    .wine-form-visible {
      display: block !important;
    }
  </style>
  
  <script>
  (function() {
    // Prevent multiple initializations
    if (window.wineFormInitialized) {
      console.log('üç∑ Form already initialized, skipping');
      return;
    }
    
    // Clear query params on load
    if (window.location.search) {
      history.replaceState(null, '', window.location.pathname);
      console.log('üç∑ Cleared query params');
    }
  
    function initializeForm() {
      console.log('üç∑ DOM loaded ‚Äì initializing wine form handler');
  
      const form = document.getElementById('wineForm');
      const price = document.getElementById('priceEstimateInput');
      const box = document.getElementById('result');
      const ty = document.getElementById('thankYouPrice');
      const submitBtn = document.getElementById('submitBtn');
      const casesContainer = document.getElementById('casesContainer');
      
      // Get input elements by ID for direct access
      const firstNameInput = document.getElementById('firstName');
      const lastNameInput = document.getElementById('lastName');
      const emailInput = document.getElementById('email');
      const phoneInput = document.getElementById('phone');
      const robotCheck = document.getElementById('robotCheck');
  
      if (!form || !price || !box || !ty || !submitBtn) {
        console.error('üî• Missing form elements');
        return;
      }
      
      // Mark as initialized
      window.wineFormInitialized = true;
  
      // Updated price map to match working example
      const caseMap = {
        "1-10": 178,
        "10-20": 260,
        "20-40": 483,
        "40-60": 632,
        "60-100": 919,
        "100-125": 1300,
        "125-140": 1450,
        "140-170": 1600,
        "170-225": 1900,
        "225-420": 2500,
        "420-690": 3500,
        "690-1000": 4500,
        "1000+": 6000
      };

      function findSelectedCase() {
        // Multiple detection methods with extensive debugging
        console.log('üç∑ Searching for selected radio button...');
        
        const selectors = [
          'input[name="cases"]:checked',
          '#casesContainer input:checked',
          '#wineForm input[name="cases"]:checked'
        ];
        
        for (let selector of selectors) {
          const found = document.querySelector(selector);
          if (found && found.checked) {
            console.log('üç∑ Found selected case via selector:', selector, 'Value:', found.value);
            return found;
          }
        }
        
        // Manual search
        const allRadios = document.querySelectorAll('input[name="cases"]');
        console.log('üç∑ All radio buttons found:', allRadios.length);
        
        for (let i = 0; i < allRadios.length; i++) {
          const radio = allRadios[i];
          console.log(`üç∑ Radio ${i}: value="${radio.value}" checked=${radio.checked}`);
          if (radio.checked) {
            console.log('üç∑ Found selected via manual search:', radio.value);
            return radio;
          }
        }
        
        console.log('üç∑ No selected case found after extensive search');
        return null;
      }
      
      function showSuccessMessage(estimate) {
        console.log('üç∑ Showing success message');
        
        // Multiple methods to hide form and show success
        try {
          form.style.display = 'none';
          form.style.visibility = 'hidden';
          form.classList.add('wine-form-hidden');
        } catch (e) {
          console.log('üç∑ Form hiding method failed:', e);
        }
        
        try {
          box.style.display = 'block';
          box.style.visibility = 'visible';
          box.classList.add('wine-form-visible');
          box.classList.remove('wine-form-hidden');
        } catch (e) {
          console.log('üç∑ Box showing method failed:', e);
        }
        
        try {
          ty.textContent = estimate;
          ty.innerHTML = estimate; // Backup method
        } catch (e) {
          console.log('üç∑ Text setting failed:', e);
        }
        
        // Scroll to success message
        setTimeout(() => {
          try {
            box.scrollIntoView({ behavior: 'smooth', block: 'center' });
          } catch (e) {
            console.log('üç∑ Scroll failed:', e);
          }
        }, 100);
      }
  
      async function handleSubmit(e) {
        if (e) {
          e.preventDefault();
          e.stopPropagation();
          e.stopImmediatePropagation();
        }
        
        console.log('üç∑ Form submit triggered');
        
        // Disable submit button immediately
        submitBtn.disabled = true;
        submitBtn.textContent = 'Submitting...';
        
        // Get selected case with enhanced detection
        const sel = findSelectedCase();
        if (!sel) {
          console.log('üç∑ No case selection found - showing alert');
          alert('Please select how many cases you\'ll be storing.');
          submitBtn.disabled = false;
          submitBtn.textContent = 'Submit';
          return false;
        }
  
        const val = sel.value;
        const p = caseMap[val];
        const est = `Estimated cost for storing ${val} cases for 6 months: $${p}`;
        
        // Manually collect all form data
        const formData = {
          first_name: firstNameInput ? firstNameInput.value.trim() : '',
          last_name: lastNameInput ? lastNameInput.value.trim() : '',
          email: emailInput ? emailInput.value.trim() : '',
          phone: phoneInput ? phoneInput.value.trim() : '',
          cases: val,
          not_a_robot: robotCheck ? (robotCheck.checked ? 'on' : '') : '',
          price_estimate: est
        };
        
        console.log('üç∑ Manually collected form data:', formData);
        
        // Validate required fields
        if (!formData.first_name || !formData.last_name || !formData.email || !formData.phone) {
          alert('Please fill in all required fields.');
          submitBtn.disabled = false;
          submitBtn.textContent = 'Submit';
          return false;
        }
  
        try {
          // Create URL-encoded body directly from our data object
          const body = new URLSearchParams(formData).toString();
          console.log('üç∑ POSTing to Worker:', body);
  
          const response = await fetch('https://wine-storage.iwv.workers.dev', {
            method: 'POST',
            mode: 'cors',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: body
          });
  
          console.log('üç∑ Worker response status:', response.status);
          
          if (!response.ok) {
            throw new Error(`Server responded with status: ${response.status}`);
          }
  
          // Parse JSON response
          const result = await response.json();
          console.log('üç∑ Response data:', result);
  
          if (result.success !== false) {
            // Success - use robust display method
            showSuccessMessage(est);
            console.log('üç∑ Form submitted successfully!');
          } else {
            throw new Error(result.message || 'Server returned an error');
          }
  
        } catch (error) {
          console.error('üç∑ Fetch error:', error);
          alert('There was a problem submitting the form. Please try again or contact us directly at info@intlwinevault.com');
          
          // Re-enable submit button
          submitBtn.disabled = false;
          submitBtn.textContent = 'Submit';
        }
        
        return false;
      }
  
      // Remove any existing listeners first
      const oldHandler = submitBtn.wineFormHandler;
      if (oldHandler) {
        submitBtn.removeEventListener('click', oldHandler);
      }
      
      // Add new listener and store reference
      submitBtn.wineFormHandler = handleSubmit;
      submitBtn.addEventListener('click', handleSubmit);
      
      console.log('üç∑ Submit handler attached');
    }
  
    // Multiple initialization methods with delays for Squarespace
    function tryInit() {
      if (document.getElementById('wineForm')) {
        initializeForm();
      } else {
        console.log('üç∑ Form not found, retrying...');
        setTimeout(tryInit, 100);
      }
    }
    
    // Immediate attempt
    tryInit();
    
    // Standard DOM ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', tryInit);
    }
    
    // Window load backup
    window.addEventListener('load', tryInit);
    
    // Squarespace-specific events
    if (window.Y && window.Y.on) {
      window.Y.on('domready', tryInit);
    }
    
    // Reset initialization flag on page change
    if (window.addEventListener) {
      window.addEventListener('beforeunload', function() {
        window.wineFormInitialized = false;
      });
    }
  })();
  </script>
  