<div style="max-width:600px;margin:0 auto;">
    <!-- === FORM === -->
    <form id="wineForm" style="border:2px solid #000;padding:30px 25px;border-radius:8px;box-sizing:border-box;font-family: 'Pontano Sans', sans-serif;" onsubmit="return false;">
      <div style="display:flex;gap:15px;margin-bottom:20px;">
        <div style="flex:1;">
          <label style="font-weight:500;display:block;margin-bottom:8px;">First Name<span class="required-asterisk">*</span></label>
          <input type="text" id="firstName" name="first_name" required style="width:100%;padding:12px;font-size:16px;border:1px solid #ccc;border-radius:6px;box-sizing:border-box;">
        </div>
        <div style="flex:1;">
          <label style="font-weight:500;display:block;margin-bottom:8px;">Last Name<span class="required-asterisk">*</span></label>
          <input type="text" id="lastName" name="last_name" required style="width:100%;padding:12px;font-size:16px;border:1px solid #ccc;border-radius:6px;box-sizing:border-box;">
        </div>
      </div>

      <div style="margin-bottom:20px;">
        <label style="font-weight:500;display:block;margin-bottom:8px;">Email<span class="required-asterisk">*</span></label>
        <input type="email" id="email" name="email" required style="width:100%;padding:12px;font-size:16px;border:1px solid #ccc;border-radius:6px;box-sizing:border-box;">
      </div>

      <div style="margin-bottom:20px;">
        <label style="font-weight:500;display:block;margin-bottom:8px;">Phone<span class="required-asterisk">*</span></label>
        <input type="tel" id="phone" name="phone" required style="width:100%;padding:12px;font-size:16px;border:1px solid #ccc;border-radius:6px;box-sizing:border-box;">
      </div>

      <div style="margin-bottom:20px;">
        <label style="font-weight:500;display:block;margin-bottom:12px;">How many cases will you be storing with us?<span class="required-asterisk">*</span></label>
        <div id="casesContainer" style="display:grid;grid-template-columns:1fr 1fr;grid-template-rows:repeat(7,auto);grid-auto-flow:column;gap:12px 20px;">
          <!-- Grid will fill column-by-column: first 7 items go to left column, next 7 to right column -->
          <label style="display:flex;align-items:center;cursor:pointer;"><input type="radio" name="cases" value="1-10" required style="margin-right:20px;"> 1‚Äì10</label>
          <label style="display:flex;align-items:center;cursor:pointer;"><input type="radio" name="cases" value="11-20" style="margin-right:20px;"> 11‚Äì20</label>
          <label style="display:flex;align-items:center;cursor:pointer;"><input type="radio" name="cases" value="21-40" style="margin-right:20px;"> 21‚Äì40</label>
          <label style="display:flex;align-items:center;cursor:pointer;"><input type="radio" name="cases" value="41-60" style="margin-right:20px;"> 41‚Äì60</label>
          <label style="display:flex;align-items:center;cursor:pointer;"><input type="radio" name="cases" value="61-70" style="margin-right:20px;"> 61‚Äì70</label>
          <label style="display:flex;align-items:center;cursor:pointer;"><input type="radio" name="cases" value="71-100" style="margin-right:20px;"> 71‚Äì100</label>
          <label style="display:flex;align-items:center;cursor:pointer;"><input type="radio" name="cases" value="101-125" style="margin-right:20px;"> 101‚Äì125</label>
          <label style="display:flex;align-items:center;cursor:pointer;"><input type="radio" name="cases" value="126-140" style="margin-right:20px;"> 126‚Äì140</label>
          <label style="display:flex;align-items:center;cursor:pointer;"><input type="radio" name="cases" value="141-170" style="margin-right:20px;"> 141‚Äì170</label>
          <label style="display:flex;align-items:center;cursor:pointer;"><input type="radio" name="cases" value="171-225" style="margin-right:20px;"> 171‚Äì225</label>
          <label style="display:flex;align-items:center;cursor:pointer;"><input type="radio" name="cases" value="226-420" style="margin-right:20px;"> 226‚Äì420</label>
          <label style="display:flex;align-items:center;cursor:pointer;"><input type="radio" name="cases" value="421-690" style="margin-right:20px;"> 421‚Äì690</label>
          <label style="display:flex;align-items:center;cursor:pointer;"><input type="radio" name="cases" value="691-1000" style="margin-right:20px;"> 691‚Äì1000</label>
          <label style="display:flex;align-items:center;cursor:pointer;"><input type="radio" name="cases" value="1000+" style="margin-right:20px;"> 1000+</label>
        </div>
      </div>

      <div style="margin-bottom:20px;">
        <label style="font-weight:500;display:block;margin-bottom:8px;">Comments (Optional)</label>
        <textarea id="comments" name="comments" placeholder="Any additional information or special requests..." style="width:100%;padding:12px;font-size:16px;border:1px solid #ccc;border-radius:6px;box-sizing:border-box;min-height:80px;resize:vertical;font-family:inherit;"></textarea>
      </div>

      <input type="hidden" name="price_estimate" id="priceEstimateInput">
      <button type="button" id="submitBtn" style="background-color:#333;color:white;padding:12px 24px;border:none;border-radius:6px;font-size:16px;cursor:pointer;font-weight:500;width:100%;font-family:inherit;">Submit</button>
    </form>

    <!-- thank-you -->
    <div id="result" style="display:none;margin-top:20px;padding:20px;border:1px solid #ccc;border-radius:6px;font-family: 'Pontano Sans', sans-serif;text-align:center;">
      <p style="margin:0 0 20px 0;font-size:16px;">Thank you! Your request has been submitted! ‚úÖ</p>
      <p id="thankYouPrice" style="font-weight:bold;margin:0 0 20px 0;font-size:16px;"></p>
      <p style="margin:0 0 20px 0;font-size:14px;">If you have any questions, please reach out to <a href="mailto:info@intlwinevault.com" class="contact-link">info@intlwinevault.com</a> or <a href="tel:+16177394401" class="contact-link">(617) 739-4401</a>.</p>
      <small style="font-size:12px;color:#666;text-align:left;display:inline-block;margin-top:15px;">
        Unit sizes are based on a standard Bordeaux case.<br>
        Prices are quoted in six-month intervals.<br>
        Amounts shown are conservative estimates and are subject to change.
      </small>
    </div>
  </div>
  
    <style>
    /* Form styling is now inline for better compatibility */
    button:hover:not(:disabled) {
      background-color: #555 !important;
    }

    button:disabled {
      background-color: #ccc !important;
      cursor: not-allowed !important;
    }
    
    .wine-form-hidden {
      display: none !important;
    }
    
    .wine-form-visible {
      display: block !important;
    }

    /* Improve radio button and checkbox styling */
    input[type="radio"], input[type="checkbox"] {
      width: auto !important;
      margin: 0 !important;
    }

    /* Match International Wine Vault website fonts */
    * {
      font-family: 'Pontano Sans', sans-serif;
    }

    /* Style required asterisks */
    .required-asterisk {
      color: #dc3545;
      font-weight: bold;
    }

    /* Style contact links */
    .contact-link {
      color: #333;
      text-decoration: underline;
    }

    .contact-link:hover {
      color: #0066cc;
    }
  </style>
  
  <script>
  (function() {
    // Prevent multiple initializations
    if (window.wineFormInitialized) {
      console.log('üç∑ Form already initialized, skipping');
      return;
    }
    
    // Clear query params on load
    if (window.location.search) {
      history.replaceState(null, '', window.location.pathname);
      console.log('üç∑ Cleared query params');
    }
  
    function initializeForm() {
      console.log('üç∑ DOM loaded ‚Äì initializing wine form handler');
  
      const form = document.getElementById('wineForm');
      const price = document.getElementById('priceEstimateInput');
      const box = document.getElementById('result');
      const ty = document.getElementById('thankYouPrice');
      const submitBtn = document.getElementById('submitBtn');
      const casesContainer = document.getElementById('casesContainer');
      
      // Get input elements by ID for direct access
      const firstNameInput = document.getElementById('firstName');
      const lastNameInput = document.getElementById('lastName');
      const emailInput = document.getElementById('email');
      const phoneInput = document.getElementById('phone');
      const commentsInput = document.getElementById('comments');
  
      if (!form || !price || !box || !ty || !submitBtn) {
        console.error('üî• Missing form elements');
        return;
      }
      
      // Mark as initialized
      window.wineFormInitialized = true;
  
      // Updated price map to match Wine Storage v2.xlsx
      const caseMap = {
        "1-10": 178,
        "11-20": 260,
        "21-40": 483,
        "41-60": 632,
        "61-70": 754,
        "71-100": 919,
        "101-125": 1150,
        "126-140": 1264,
        "141-170": 1545,
        "171-225": 2025,
        "226-420": 3200,
        "421-690": 4830,
        "691-1000": 5500,
        "1000+": "contact"
      };

      function findSelectedCase() {
        // Multiple detection methods with extensive debugging
        console.log('üç∑ Searching for selected radio button...');
        
        const selectors = [
          'input[name="cases"]:checked',
          '#casesContainer input:checked',
          '#wineForm input[name="cases"]:checked'
        ];
        
        for (let selector of selectors) {
          const found = document.querySelector(selector);
          if (found && found.checked) {
            console.log('üç∑ Found selected case via selector:', selector, 'Value:', found.value);
            return found;
          }
        }
        
        // Manual search
        const allRadios = document.querySelectorAll('input[name="cases"]');
        console.log('üç∑ All radio buttons found:', allRadios.length);
        
        for (let i = 0; i < allRadios.length; i++) {
          const radio = allRadios[i];
          console.log(`üç∑ Radio ${i}: value="${radio.value}" checked=${radio.checked}`);
          if (radio.checked) {
            console.log('üç∑ Found selected via manual search:', radio.value);
            return radio;
          }
        }
        
        console.log('üç∑ No selected case found after extensive search');
        return null;
      }
      
      function showSuccessMessage(estimate) {
        console.log('üç∑ Showing success message');
        
        // Multiple methods to hide form and show success
        try {
          form.style.display = 'none';
          form.style.visibility = 'hidden';
          form.classList.add('wine-form-hidden');
        } catch (e) {
          console.log('üç∑ Form hiding method failed:', e);
        }
        
        try {
          box.style.display = 'block';
          box.style.visibility = 'visible';
          box.classList.add('wine-form-visible');
          box.classList.remove('wine-form-hidden');
        } catch (e) {
          console.log('üç∑ Box showing method failed:', e);
        }
        
        try {
          ty.textContent = estimate;
          ty.innerHTML = estimate; // Backup method
        } catch (e) {
          console.log('üç∑ Text setting failed:', e);
        }
        
        // Scroll to success message
        setTimeout(() => {
          try {
            box.scrollIntoView({ behavior: 'smooth', block: 'center' });
          } catch (e) {
            console.log('üç∑ Scroll failed:', e);
          }
        }, 100);
      }
  
      async function handleSubmit(e) {
        if (e) {
          e.preventDefault();
          e.stopPropagation();
          e.stopImmediatePropagation();
        }
        
        console.log('üç∑ Form submit triggered');
        
        // Disable submit button immediately
        submitBtn.disabled = true;
        submitBtn.textContent = 'Submitting...';
        
        // Get selected case with enhanced detection
        const sel = findSelectedCase();
        if (!sel) {
          console.log('üç∑ No case selection found - showing alert');
          alert('Please select how many cases you\'ll be storing.');
          submitBtn.disabled = false;
          submitBtn.textContent = 'Submit';
          return false;
        }
  
        const val = sel.value;
        const p = caseMap[val];
        let est;
        
        if (p === "contact") {
          est = `For storing ${val} cases: Please contact us for a custom quote`;
        } else {
          est = `Storing ${val} cases for 6 months is estimated to cost $${p.toLocaleString()}.`;
        }
        
        // Manually collect all form data
        const formData = {
          first_name: firstNameInput ? firstNameInput.value.trim() : '',
          last_name: lastNameInput ? lastNameInput.value.trim() : '',
          email: emailInput ? emailInput.value.trim() : '',
          phone: phoneInput ? phoneInput.value.trim() : '',
          cases: val,
          comments: commentsInput ? commentsInput.value.trim() : '',
          price_estimate: est
        };
        
        console.log('üç∑ Manually collected form data:', formData);
        
        // Validate required fields
        if (!formData.first_name || !formData.last_name || !formData.email || !formData.phone) {
          alert('Please fill in all required fields.');
          submitBtn.disabled = false;
          submitBtn.textContent = 'Submit';
          return false;
        }
  
        try {
          // Create URL-encoded body directly from our data object
          const body = new URLSearchParams(formData).toString();
          console.log('üç∑ POSTing to Worker:', body);
  
          const response = await fetch('https://wine-storage.iwv.workers.dev', {
            method: 'POST',
            mode: 'cors',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: body
          });
  
          console.log('üç∑ Worker response status:', response.status);
          
          if (!response.ok) {
            throw new Error(`Server responded with status: ${response.status}`);
          }
  
          // Parse JSON response
          const result = await response.json();
          console.log('üç∑ Response data:', result);
  
          if (result.success !== false) {
            // Success - use robust display method
            showSuccessMessage(est);
            console.log('üç∑ Form submitted successfully!');
          } else {
            throw new Error(result.message || 'Server returned an error');
          }
  
        } catch (error) {
          console.error('üç∑ Fetch error:', error);
          alert('There was a problem submitting the form. Please try again or contact us directly at info@intlwinevault.com');
          
          // Re-enable submit button
          submitBtn.disabled = false;
          submitBtn.textContent = 'Submit';
        }
        
        return false;
      }
  
      // Remove any existing listeners first
      const oldHandler = submitBtn.wineFormHandler;
      if (oldHandler) {
        submitBtn.removeEventListener('click', oldHandler);
      }
      
      // Add new listener and store reference
      submitBtn.wineFormHandler = handleSubmit;
      submitBtn.addEventListener('click', handleSubmit);
      
      console.log('üç∑ Submit handler attached');
    }
  
    // Multiple initialization methods with delays for Squarespace
    function tryInit() {
      if (document.getElementById('wineForm')) {
        initializeForm();
      } else {
        console.log('üç∑ Form not found, retrying...');
        setTimeout(tryInit, 100);
      }
    }
    
    // Immediate attempt
    tryInit();
    
    // Standard DOM ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', tryInit);
    }
    
    // Window load backup
    window.addEventListener('load', tryInit);
    
    // Squarespace-specific events
    if (window.Y && window.Y.on) {
      window.Y.on('domready', tryInit);
    }
    
    // Reset initialization flag on page change
    if (window.addEventListener) {
      window.addEventListener('beforeunload', function() {
        window.wineFormInitialized = false;
      });
    }
  })();
  </script>
  